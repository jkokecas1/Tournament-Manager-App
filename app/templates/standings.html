{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>{{ _('Standings') }}</h2>
    <button onclick="exportStandingsAsImage()" class="btn btn-primary">
        {{ _('Export as Image') }}
    </button>
</div>

<!-- Modal for image preview -->
<div id="imageModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div
        style="background: white; padding: 30px; border-radius: 15px; max-width: 50%; max-height: 90%; overflow: auto; position: relative;">
        <button onclick="closeModal()"
            style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;">√ó</button>

        <h3 style="margin-top: 0; color: #2c3e50; text-align: center;">{{ _('Standings Image') }}</h3>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button onclick="copyToClipboard()" class="btn btn-primary">
                üìã {{ _('Copy to Clipboard') }}
            </button>
            <button onclick="downloadImage()" class="btn btn-primary">
                üíæ {{ _('Download') }}
            </button>
        </div>
        <div style="text-align: center; margin: 20px 0;">
            <img id="previewImage" src="" alt="Preview"
                style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        </div>
        <div id="copyMessage"
            style="display: none; text-align: center; margin-top: 15px; padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; font-weight: 600;">
            ‚úÖ {{ _('Image copied to clipboard!') }}
        </div>
    </div>
</div>

<!-- Hidden container for image export -->
<div id="exportContainer"
    style="position: absolute; left: -9999px; top: -9999px; background: white; padding: 40px; width: 1200px; z-index: -9999; visibility: hidden;">
    <!-- Header with logo, company name, and tournament -->
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2c3e50; padding-bottom: 20px;">
        {% if site_config and site_config.company_logo %}
        <img src="{{ url_for('static', filename='uploads/' + site_config.company_logo) }}" alt="Logo"
            style="max-height: 80px; margin-bottom: 15px;">
        {% endif %}
        <h1 style="margin: 10px 0; color: #2c3e50; font-size: 32px;">
            {{ site_config.company_name if site_config and site_config.company_name else 'Tournament Manager' }}
        </h1>
        <h2 style="margin: 5px 0; color: #34495e; font-size: 24px;">{{ t.name }} - {{ _('Standings') }}</h2>
    </div>

    <!-- Standings table -->
    <table id="standingsTableExport"
        style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <thead>
            <tr style="background: #2c3e50; color: black;">
                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">{{ _('Pos') }}</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">{{ _('Team') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('P') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('W') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('D') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('L') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('GF') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('GA') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('GD') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('Pts') }}</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">{{ _('Last 5') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for team in standings %}
            <tr style="background: {{ '#f8f9fa' if loop.index % 2 == 0 else 'white' }};">
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">{{ loop.index
                    }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        {% if team.team.logo_data %}
                        <img src="{{ url_for('tournaments.team_logo', t_id=t.id, team_id=team.team.id) }}" alt="Logo"
                            style="width: 25px; height: 25px; object-fit: contain;">
                        {% else %}
                        <span style="font-size: 20px;">‚öΩ</span>
                        {% endif %}
                        <strong>{{ team.name }}</strong>
                    </div>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.played }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.won }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.drawn }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.lost }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.gf }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.ga }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.gf - team.ga }}</td>
                <td
                    style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 16px;">
                    {{ team.points }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                    {% for result in team.form %}
                    {% if result == 'W' %}
                    <span>‚úÖ</span>
                    {% elif result == 'D' %}
                    <span>‚ûñ</span>
                    {% else %}
                    <span>‚ùå</span>
                    {% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Visible table on page -->
<table>
    <thead>
        <tr>
            <th>{{ _('Pos') }}</th>
            <th>{{ _('Team') }}</th>
            <th>{{ _('P') }}</th>
            <th>{{ _('W') }}</th>
            <th>{{ _('D') }}</th>
            <th>{{ _('L') }}</th>
            <th>{{ _('GF') }}</th>
            <th>{{ _('GA') }}</th>
            <th>{{ _('GD') }}</th>
            <th>{{ _('Pts') }}</th>
            <th>{{ _('Last 5') }}</th>
        </tr>
    </thead>
    <tbody>
        {% for team in standings %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if team.team.logo_data %}
                    <img src="{{ url_for('tournaments.team_logo', t_id=t.id, team_id=team.team.id) }}" alt="Logo"
                        style="width: 25px; height: 25px; object-fit: contain;">
                    {% else %}
                    <span style="font-size: 20px;">‚öΩ</span>
                    {% endif %}
                    <strong>{{ team.name }}</strong>
                </div>
            </td>
            <td>{{ team.played }}</td>
            <td>{{ team.won }}</td>
            <td>{{ team.drawn }}</td>
            <td>{{ team.lost }}</td>
            <td>{{ team.gf }}</td>
            <td>{{ team.ga }}</td>
            <td>{{ team.gf - team.ga }}</td>
            <td><strong>{{ team.points }}</strong></td>
            <td>
                {% for result in team.form %}
                {% if result == 'W' %}
                <span title="{{ _('Won') }}">‚úÖ</span>
                {% elif result == 'D' %}
                <span title="{{ _('Drawn') }}">‚ûñ</span>
                {% else %}
                <span title="{{ _('Lost') }}">‚ùå</span>
                {% endif %}
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let generatedImageBlob = null;
    let generatedImageDataUrl = null;

    function exportStandingsAsImage() {
        const exportContainer = document.getElementById('exportContainer');

        // Make visible but keep off-screen/transparent for rendering
        exportContainer.style.visibility = 'visible';
        exportContainer.style.opacity = '1';
        exportContainer.style.position = 'fixed';
        exportContainer.style.left = '0';
        exportContainer.style.top = '0';
        exportContainer.style.zIndex = '-9999';

        // Small delay to ensure the browser has actually rendered the element
        setTimeout(() => {
            html2canvas(exportContainer, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: 1280,
                windowHeight: 720
            }).then(canvas => {
                // Hide the container again
                exportContainer.style.visibility = 'hidden';
                exportContainer.style.opacity = '0';
                exportContainer.style.position = 'absolute';
                exportContainer.style.left = '-9999px';
                exportContainer.style.top = '-9999px';
                exportContainer.style.zIndex = '-9999';

                // Store the image data
                generatedImageDataUrl = canvas.toDataURL('image/png');

                // Convert to blob for clipboard
                canvas.toBlob(blob => {
                    generatedImageBlob = blob;
                }, 'image/png');

                // Show modal with preview
                document.getElementById('previewImage').src = generatedImageDataUrl;
                document.getElementById('imageModal').style.display = 'flex';
            });
        }, 100);
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
        document.getElementById('copyMessage').style.display = 'none';
    }

    async function copyToClipboard() {
        try {
            if (generatedImageBlob) {
                const item = new ClipboardItem({ 'image/png': generatedImageBlob });
                await navigator.clipboard.write([item]);

                // Show success message
                const message = document.getElementById('copyMessage');
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }
        } catch (err) {
            alert('{{ _("Error copying to clipboard. Please try downloading instead.") }}');
            console.error('Error copying to clipboard:', err);
        }
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'clasificacion_{{ t.name|replace(" ", "_") }}.png';
        link.href = generatedImageDataUrl;
        link.click();
    }

    // Close modal when clicking outside
    document.getElementById('imageModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}