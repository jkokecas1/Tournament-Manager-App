{% extends "sidebar_layout.html" %}

{% block layout_content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2 style="margin: 0;">{{ _('üèÜ Tabla de Posiciones') }}</h2>
    <button onclick="exportStandingsAsImage()" class="btn btn-primary" style="font-size: 0.9em;">
        üì∏ {{ _('Exportar como Imagen') }}
    </button>
</div>

<!-- Modal for image preview -->
<div id="imageModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div
        style="background: white; padding: 30px; border-radius: 15px; max-width: 50%; max-height: 90%; overflow: auto; position: relative;">
        <button onclick="closeModal()"
            style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;">√ó</button>

        <h3 style="margin-top: 0; color: #2c3e50; text-align: center;">{{ _('Imagen de Posiciones') }}</h3>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button onclick="copyToClipboard()" class="btn btn-primary">
                üìã {{ _('Copiar portapapeles') }}
            </button>
            <button onclick="downloadImage()" class="btn btn-primary">
                üíæ {{ _('Descargar') }}
            </button>
        </div>
        <div style="text-align: center; margin: 20px 0;">
            <img id="previewImage" src="" alt="Preview"
                style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        </div>
        <div id="copyMessage"
            style="display: none; text-align: center; margin-top: 15px; padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; font-weight: 600;">
            ‚úÖ {{ _('¬°Imagen copiada!') }}
        </div>
    </div>
</div>

<!-- Hidden container for image export -->
<div id="exportContainer"
    style="position: absolute; left: -9999px; top: -9999px; background: white; padding: 40px; width: 1200px; z-index: -9999; visibility: hidden;">
    <!-- Export Header -->
    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2c3e50; padding-bottom: 20px;">
        {% if site_config and site_config.company_logo %}
        <img src="{{ url_for('static', filename='uploads/' + site_config.company_logo) }}" alt="Logo"
            style="max-height: 80px; margin-bottom: 15px;">
        {% endif %}
        <h1 style="margin: 10px 0; color: #2c3e50; font-size: 32px;">
            {{ site_config.company_name if site_config and site_config.company_name else 'Tournament Manager' }}
        </h1>
        <h2 style="margin: 5px 0; color: #34495e; font-size: 24px;">{{ t.name }} - {{ _('Posiciones') }}</h2>
    </div>

    <!-- Export Table -->
    <table id="standingsTableExport" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #2c3e50; color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('Pos') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('Equipo') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('PJ') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('G') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('E') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('P') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('GF') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('GC') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('DG') }}</th>
                <th style="padding: 12px; border: 1px solid #ddd;">{{ _('Pts') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for team in standings %}
            <tr style="background: {{ '#f8f9fa' if loop.index % 2 == 0 else 'white' }};">
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">{{ loop.index
                    }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        {% if team.team.logo_data %}
                        <img src="{{ url_for('tournaments.team_logo', t_id=t.id, team_id=team.team.id) }}"
                            style="width: 25px; height: 25px;">
                        {% endif %}
                        <strong>{{ team.name }}</strong>
                    </div>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.played }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.won }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.drawn }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.lost }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.gf }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.ga }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">{{ team.gf - team.ga }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">{{ team.points
                    }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="padding: 0; overflow: hidden; border: 1px solid #eee;">
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
        <thead style="background: #f8f9fa;">
            <tr>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{
                    _('Pos') }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; text-align: left;">{{ _('Equipo') }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('PJ')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('G')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('E')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('P')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('GF')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('GC')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 60px; text-align: center;">{{ _('DG')
                    }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 80px; text-align: center;">{{
                    _('Pts') }}</th>
                <th style="padding: 15px; border-bottom: 2px solid #dee2e6; width: 140px; text-align: center;">{{
                    _('√öltimos 5') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for team in standings %}
            <tr style="border-bottom: 1px solid #f1f3f5; {{ 'background: #fdfdfe;' if loop.index <= 4 }}">
                <td
                    style="padding: 15px; text-align: center; font-weight: bold; color: {{ '#3498db' if loop.index <= 4 else '#7f8c8d' }};">
                    {{ loop.index }}
                </td>
                <td style="padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        {% if team.team.logo_data %}
                        <img src="{{ url_for('tournaments.team_logo', t_id=t.id, team_id=team.team.id) }}"
                            style="width: 28px; height: 28px; object-fit: contain;">
                        {% endif %}
                        <strong>{{ team.name }}</strong>
                    </div>
                </td>
                <td style="padding: 15px; text-align: center;">{{ team.played }}</td>
                <td style="padding: 15px; text-align: center; color: #27ae60;">{{ team.won }}</td>
                <td style="padding: 15px; text-align: center; color: #f39c12;">{{ team.drawn }}</td>
                <td style="padding: 15px; text-align: center; color: #e74c3c;">{{ team.lost }}</td>
                <td style="padding: 15px; text-align: center;">{{ team.gf }}</td>
                <td style="padding: 15px; text-align: center;">{{ team.ga }}</td>
                <td style="padding: 15px; text-align: center; font-weight: bold;">{{ team.gf - team.ga }}</td>
                <td style="padding: 15px; text-align: center; font-weight: 800; font-size: 1.1rem; color: #2c3e50;">{{
                    team.points }}</td>
                <td style="padding: 15px; text-align: center;">
                    <div style="display: flex; gap: 4px; justify-content: center;">
                        {% for result in team.form %}
                        <span style="font-size: 0.85em; cursor: default;" title="{{ result }}">
                            {% if result == 'W' %}‚úÖ{% elif result == 'D' %}‚ûñ{% else %}‚ùå{% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let generatedImageBlob = null;
    let generatedImageDataUrl = null;

    function exportStandingsAsImage() {
        const exportContainer = document.getElementById('exportContainer');
        exportContainer.style.visibility = 'visible';
        exportContainer.style.opacity = '1';
        exportContainer.style.position = 'fixed';
        exportContainer.style.left = '0';
        exportContainer.style.top = '0';
        exportContainer.style.zIndex = '-9999';

        setTimeout(() => {
            html2canvas(exportContainer, {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true
            }).then(canvas => {
                exportContainer.style.visibility = 'hidden';
                exportContainer.style.opacity = '0';
                generatedImageDataUrl = canvas.toDataURL('image/png');
                canvas.toBlob(blob => { generatedImageBlob = blob; }, 'image/png');
                document.getElementById('previewImage').src = generatedImageDataUrl;
                document.getElementById('imageModal').style.display = 'flex';
            });
        }, 100);
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
        document.getElementById('copyMessage').style.display = 'none';
    }

    async function copyToClipboard() {
        try {
            if (generatedImageBlob) {
                const item = new ClipboardItem({ 'image/png': generatedImageBlob });
                await navigator.clipboard.write([item]);
                document.getElementById('copyMessage').style.display = 'block';
                setTimeout(() => { document.getElementById('copyMessage').style.display = 'none'; }, 3000);
            }
        } catch (err) { alert('Error al copiar.'); }
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'clasificacion_{{ t.name|replace(" ", "_") }}.png';
        link.href = generatedImageDataUrl;
        link.click();
    }
</script>
{% endblock %}