{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>{{ _('ðŸ‘¤ User Management') }}</h2>
    <a href="{{ url_for('admin.admin_panel') }}" class="btn btn-secondary">{{ _('Back to Admin') }}</a>
</div>

<div class="grid">
    <!-- Create User Form -->
    <div class="card">
        <h3>{{ _('âž• Create User') }}</h3>
        <form action="{{ url_for('admin.manage_users') }}" method="post">
            <label>Username</label>
            <input type="text" name="username" required>

            <label>Password</label>
            <input type="password" name="password" required
                style="width: 95%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">

            <label>{{ _('Role:') }}</label>
            <select name="role" id="roleSelect" onchange="toggleTeamSelect()">
                <option value="user">User</option>
                <option value="rep">Representative</option>
                <option value="referee">Referee</option>
                <option value="admin">Admin</option>
            </select>

            <div id="teamSelectDiv" style="display: none; margin-top: 10px;">
                <label>{{ _('Assign Team (For Reps):') }}</label>
                <select name="team_id">
                    <option value="">-- Select Team --</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}">{{ team.tournament.name }} - {{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn">{{ _('Create User') }}</button>
        </form>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>{{ _('ðŸ¤– Bulk Generation') }}</h3>
            <p style="font-size: 0.9em; color: #666;">{{ _('Generate a representative user for every team that doesn\'t
                have one yet.') }}</p>
            <form action="{{ url_for('admin.generate_reps') }}" method="post">
                <button type="submit" class="btn" style="background-color: #3498db;">{{ _('Generate Team Users')
                    }}</button>
            </form>
        </div>
    </div>

    <!-- User Table -->
    <div class="card" style="grid-column: span 2;">
        <h3>{{ _('ðŸ“œ All Users') }}</h3>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Assigned Team</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td><strong>{{ u.username }}</strong></td>
                        <td><span class="badge">{{ u.role }}</span></td>
                        <td>
                            {% if u.team_id %}
                            {% set team = teams | selectattr("id", "equalto", u.team_id) | first %}
                            {{ team.name if team else u.team_id }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm"
                                onclick="copyCredentials('{{ u.username }}', '{{ u.password }}')"
                                title="{{ _('Copy Username and Password') }}">
                                ðŸ“‹ {{ _('Copy') }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function copyCredentials(username, password) {
        const textToCopy = `${username}:${password}`;
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert(`{{ _('Credentials copied to clipboard for') }} ${username}`);
        }).catch(err => {
            console.error('Error copying text: ', err);
        });
    }

    function toggleTeamSelect() {
        var role = document.getElementById("roleSelect").value;
        var teamDiv = document.getElementById("teamSelectDiv");
        if (role === "rep") {
            teamDiv.style.display = "block";
        } else {
            teamDiv.style.display = "none";
        }
    }
</script>

<style>
    .badge {
        display: inline-block;
        padding: 2px 8px;
        background: #eee;
        border-radius: 12px;
        font-size: 0.85em;
        text-transform: capitalize;
    }
</style>
{% endblock %}